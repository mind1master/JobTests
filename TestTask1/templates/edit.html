{% extends "base.html" %}

{% block js %}

    <script type="text/javascript" src="/static/js/jquery.js"></script>
    <script type="text/javascript" src="/static/js/jquery.form.js"></script>
    {{ form.media }}
    <script type="text/javascript">
        function display_form_errors(errors, $form) {
            for (var k in errors) {
                $form.find('input[name=' + k + ']').after('<div class="error">' + errors[k] + '</div>');
            }
        }
        $(document).ready(function () {
            $('#load').hide();
            $('#error').hide();
            $('#success').hide();
            $('#save').live('click', function () {
                $('#save_form').ajaxSubmit({
                    success:function (data, statusText, xhr, $form) {
                        // $form.find('input, textarea').attr('disabled','disabled');
                        $('input, textarea').attr('disabled', 'disabled');
                        $('#error').hide();
                        $('#success').hide();
                        $('#load').show("fast");
                        $form.find('.error').remove();
                        if (data['result'] == 'success') {
                            $('#photo').attr('src', data['response']);
                            $('#success').show("slow");
                        }
                        else if (data['result'] == 'error') {
                            // Показываем ошибки
                            $('#error').show("fast");
                            display_form_errors(data['response'], $form);
                        }
                        $('#load').hide("fast");
                        $('input, textarea').removeAttr('disabled');
                    },
                    dataType:'json'
                });
            });
        })
    </script>
    <style type="text/css">
        .yellow {
            background: yellow;
        }

        .red {
            background: red;
        }

        .green {
            background: #adff2f;
        }

        .error {
            color: red;
        }
    </style>
{% endblock %}

{% block content %}
    <div id="load" class="yellow">
        Loading...
    </div>
    <div id="success" class="green">
        Success!
    </div>
    <div id="error" class="red">
        There are errors!
    </div>
    <form id="save_form" enctype="multipart/form-data" action="/edit/" method="post">{% csrf_token %}
        <table>
            <td width="300px">
                {% for field in form %}

                    <div class="fieldWrapper">
                        {% if field.label == 'Photo' %}
                            {{ form.photo.errors }}
                            <label for="id_photo">Photo:</label><br>
                            <img id="photo" width="150px" src="{{ profile.photo.url }}" alt=""><br>
                            Change: <input type="file" name="photo" id="id_photo"/>
                        {% else %}
                            {{ field.errors }}
                            {{ field.label_tag }}: {{ field }}
                        {% endif %}
                    </div>
                    {% if forloop.counter == 4 %}
                        </td>
                        <td>
                    {% endif %}
                {% endfor %}
                </td>
        </table>
        <p><a href="#" id="save">Save</a>
    </form>
{% endblock %}
